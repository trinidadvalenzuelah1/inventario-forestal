<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Forestal - Jesús María Tosibuena</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <script src="https://unpkg.com/leaflet-mbtiles/leaflet-mbtiles.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <style>
        :root { --forest-green: #2e7d32; --alert-red: #d32f2f; --info-blue: #1976d2; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #eceff1; color: #333; }
        header { background: var(--forest-green); color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; color: var(--forest-green); border-bottom: 2px solid #eee; padding-bottom: 5px; }
        
        .gps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #333; color: #0f0; font-family: monospace; padding: 10px; border-radius: 4px; }
        .gps-item { border: 1px solid #444; padding: 5px; border-radius: 3px; font-size: 0.85rem; }
        
        #map { height: 250px; width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #ccc; }
        
        label { display: block; font-weight: bold; margin-top: 10px; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1rem; }
        
        .audit-error { border: 2px solid var(--alert-red) !important; background: #ffebee; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; color: white; transition: 0.3s; }
        .btn-save { background: var(--forest-green); }
        .btn-sync { background: var(--info-blue); }
        .btn-clear { background: #757575; }
        
        .status-badge { padding: 12px; border-radius: 4px; font-weight: bold; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <h1>Jesús María Tosibuena</h1>
    <small>Sinaloa - Inventario Forestal de Manejo</small>
</header>

<div class="container">
    <div class="card" style="border-top: 6px solid var(--info-blue);">
        <h3>Control de Rodal</h3>
        <label>ID del Rodal / Predio:</label>
        <input type="text" id="rodal" placeholder="Ej: R-01" oninput="renderizarProgreso(this.value)">
        <div id="status_rodal" class="status-badge">Ingrese un rodal para ver progreso</div>
        <p style="font-size: 0.85rem;">Sitios capturados: <span id="contador_sitios_rodal">0</span> / 2 (Mínimo requerido)</p>
    </div>

    <div class="card">
        <h3>Localización Geográfica</h3>
        <div class="gps-grid">
            <div class="gps-item">Lat: <span id="lat">0.0</span></div>
            <div class="gps-item">Lon: <span id="lon">0.0</span></div>
            <div class="gps-item">UTM X: <span id="utm_x">0.0</span></div>
            <div class="gps-item">UTM Y: <span id="utm_y">0.0</span></div>
            <div class="gps-item">Precisión: <span id="acc">0</span>m</div>
            <div class="gps-item">ASNM: <span id="alt">--</span>m</div>
        </div>
        <div id="map"></div>
    </div>

    <div class="card">
        <h3>I. Información del Sitio</h3>
        <label>Número de Sitio:</label>
        <input type="number" id="num_sitio" placeholder="Número según diseño">
        <label>Fecha:</label>
        <input type="date" id="fecha">
        <label>Exposición (Cat. 16):</label>
        <select id="exposicion"><option value="">Seleccione...</option></select>
        <label>Uso Actual UAS (Cat. 22):</label>
        <select id="uso_actual"><option value="">Seleccione...</option></select>
        <label>Pendiente (%):</label>
        <input type="number" id="pendiente" placeholder="0 - 100" onchange="validarPendiente(this)">
    </div>

    <div class="card">
        <h3>II. Arbolado Comercial (Dn ≥ 7.5)</h3>
        <div id="lista-arboles">
            <div class="fila-arbol" style="display: flex; gap: 5px; margin-bottom: 8px;">
                <select id="esp1" style="flex:2.5; font-size: 0.85rem;"><option value="">Especie</option></select>
                <input type="number" step="0.1" placeholder="Dn" style="flex:1" onchange="validarDn(this)">
                <input type="number" step="0.1" placeholder="At" style="flex:1" id="at1">
                <input type="number" step="0.1" placeholder="Ac" style="flex:1" onchange="validarAc(this, 'at1')">
            </div>
        </div>
        <button type="button" class="btn" style="background:#607d8b; padding:8px;" onclick="agregarFilaArbol()">+ Añadir Árbol</button>
    </div>

    <div class="card">
        <h3>III. Sanidad (Grado Cs)</h3>
        <select id="sanidad_grado">
            <option value="1">1 - Sano (No presente)</option>
            <option value="2">2 - Poco (1-33%)</option>
            <option value="3">3 - Moderado (33-66%)</option>
            <option value="4">4 - Intenso (>66%)</option>
        </select>
    </div>

    <button class="btn btn-save" onclick="guardarSitio()">GUARDAR EN DISPOSITIVO</button>
    <button class="btn btn-sync" onclick="sincronizarSupabase()">SINCRONIZAR A LA NUBE</button>
    <button class="btn btn-clear" onclick="resetFormulario()">NUEVO SITIO / LIMPIAR</button>
</div>

<script>
    // 1. CONFIGURACIÓN INICIAL
    const wgs84 = "+proj=longlat +datum=WGS84 +no_defs";
    const utm13N = "+proj=utm +zone=13 +datum=WGS84 +units=m +no_defs";
    
    // Supabase (Reemplazar con tus credenciales reales)
    const supabaseUrl = 'https://xrgjbnelerhztobbciix.supabase.co';
    const supabaseKey = 'TU_KEY_REAL_AQUI';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    var map, marker, capaRodales;

    // 2. CATÁLOGOS SINALOA
    const CATALOGOS = {
        especies: [
            {id: 1, n: "Pinus cooperi"}, {id: 2, n: "Pinus durangensis"}, {id: 3, n: "Pinus arizonica"},
            {id: 4, n: "Pinus engelmannii"}, {id: 82, n: "Quercus sideroxyla"}, {id: 112, n: "Otras hojosas"}
        ],
        exposicion: [
            {id: 1, n: "Zenital (Z)"}, {id: 2, n: "Norte (N)"}, {id: 3, n: "Noreste (NE)"},
            {id: 4, n: "Este (E)"}, {id: 5, n: "Sur (S)"}, {id: 9, n: "Noroeste (NO)"}
        ],
        uas: [
            {id: 1, n: "Forestal producción maderable"}, {id: 2, n: "Forestal Protección"}, {id: 17, n: "Asentamientos"}
        ]
    };

    // 3. INICIALIZACIÓN DE MOTOR OFFLINE Y MAPA
    const configuracionSql = {
        locateFile: filename => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${filename}`
    };

    initSqlJs(configuracionSql).then(function(SQL){
        map = L.map('map').setView([25.8, -108.0], 14);

        // Capa online tenue
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.4 }).addTo(map);

        // Capa OFFLINE (MBTiles) - El archivo debe estar en la carpeta del servidor
        capaRodales = L.tileLayer.mbTiles('mapa_rodales.mbtiles', {
            minZoom: 12, maxZoom: 18, attribution: 'Comunidad J.M. Tosibuena'
        }).addTo(map);

        marker = L.marker([0,0]).addTo(map);
        iniciarGPS();
        poblarSelects();
    });

    function poblarSelects() {
        const sEsp = document.getElementById('esp1');
        CATALOGOS.especies.forEach(e => sEsp.options.add(new Option(`${e.id}-${e.n}`, e.id)));
        CATALOGOS.exposicion.forEach(e => document.getElementById('exposicion').options.add(new Option(e.n, e.id)));
        CATALOGOS.uas.forEach(e => document.getElementById('uso_actual').options.add(new Option(e.n, e.id)));
        document.getElementById('fecha').valueAsDate = new Date();
    }

    // 4. LÓGICA GPS
    function iniciarGPS() {
        navigator.geolocation.watchPosition(pos => {
            const {latitude, longitude, accuracy, altitude} = pos.coords;
            const coordsUTM = proj4(wgs84, utm13N, [longitude, latitude]);

            document.getElementById('lat').innerText = latitude.toFixed(6);
            document.getElementById('lon').innerText = longitude.toFixed(6);
            document.getElementById('utm_x').innerText = coordsUTM[0].toFixed(2);
            document.getElementById('utm_y').innerText = coordsUTM[1].toFixed(2);
            document.getElementById('acc').innerText = accuracy.toFixed(0);
            document.getElementById('alt').innerText = altitude ? altitude.toFixed(0) : '--';

            marker.setLatLng([latitude, longitude]);
            map.panTo([latitude, longitude]);
        }, null, {enableHighAccuracy: true});
    }

    // 5. DINÁMICA DE ARBOLADO
    let contadorArboles = 1;
    function agregarFilaArbol() {
        contadorArboles++;
        const lista = document.getElementById('lista-arboles');
        const div = document.createElement('div');
        div.className = 'fila-arbol';
        div.style = "display: flex; gap: 5px; margin-bottom: 8px;";
        const idAt = `at${contadorArboles}`;
        div.innerHTML = `
            <select id="esp${contadorArboles}" style="flex:2.5; font-size: 0.85rem;"><option value="">Especie</option></select>
            <input type="number" step="0.1" placeholder="Dn" style="flex:1" onchange="validarDn(this)">
            <input type="number" step="0.1" placeholder="At" style="flex:1" id="${idAt}">
            <input type="number" step="0.1" placeholder="Ac" style="flex:1" onchange="validarAc(this, '${idAt}')">
        `;
        lista.appendChild(div);
        const sel = document.getElementById(`esp${contadorArboles}`);
        CATALOGOS.especies.forEach(e => sel.options.add(new Option(`${e.id}-${e.n}`, e.id)));
    }

    // 6. VALIDACIONES
    function validarDn(el) { el.value < 7.5 ? el.classList.add('audit-error') : el.classList.remove('audit-error'); }
    function validarAc(el, idAt) {
        const atVal = parseFloat(document.getElementById(idAt).value);
        (parseFloat(el.value) >= atVal) ? el.classList.add('audit-error') : el.classList.remove('audit-error');
    }
    function validarPendiente(el) { (el.value < 0 || el.value > 100) ? el.classList.add('audit-error') : el.classList.remove('audit-error'); }

    // 7. PERSISTENCIA LOCAL Y SINCRONIZACIÓN
    let sitesData = JSON.parse(localStorage.getItem('tosibuena_muestreo')) || {};

    function renderizarProgreso(rodalId) {
        if(!rodalId) return;
        const total = Object.values(sitesData).filter(s => s.rodal === rodalId).length;
        document.getElementById('contador_sitios_rodal').innerText = total;
        const status = document.getElementById('status_rodal');
        if(total >= 2) {
            status.innerText = "✅ RODAL CUMPLIDO"; status.style.background = "#c8e6c9"; status.style.color = "#2e7d32";
        } else {
            status.innerText = "⚠️ MUESTREO PENDIENTE"; status.style.background = "#ffcdd2"; status.style.color = "#b71c1c";
        }
    }

    function guardarSitio() {
        const r = document.getElementById('rodal').value;
        if(!r) return alert("Falta ID de Rodal");
        const id = Date.now();
        sitesData[id] = { rodal: r, num: document.getElementById('num_sitio').value, fecha: document.getElementById('fecha').value };
        localStorage.setItem('tosibuena_muestreo', JSON.stringify(sitesData));
        renderizarProgreso(r);
        alert("Sitio guardado en el teléfono.");
    }

    function sincronizarSupabase() {
        const total = Object.keys(sitesData).length;
        if(total === 0) return alert("No hay datos pendientes.");
        alert("Sincronizando " + total + " sitios a la nube...");
        // Aquí se ejecuta el .insert() a Supabase
    }

    function resetFormulario() {
        if(confirm("¿Limpiar formulario para nuevo sitio?")) location.reload();
    }
</script>
</body>
</html>
